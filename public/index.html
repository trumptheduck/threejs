<!DOCTYPE html>
<html lang="en">
	<head>
        <link rel="manifest" href="/js/pwa.webmanifest">
        <link rel="apple-touch-icon" href="/images/icon-256x256.png">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff"/>
        <title>Page Title</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    </head>
    <style>
        body {
            margin: 0px;
            overflow: hidden;
        }
        #container {
            position: absolute;
            top: 0%;
            left: 0%;
            width: 100%;
            height: 100%;
            z-index: 0;
        }
        #ui-layer {
            position: absolute;
            top: 0%;
            left: 0%;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
    </style>
	<body>
        <div id="container"></div>
        <div id="ui-layer">
            <div id="ui-crosshair" style="
            width: 10px;
            height: 10px;
            position: absolute;
            border-radius: 100px;
            top:0;
            bottom: 0;
            left: 0;
            right: 0;
            border: white solid 1.5px;
            background-color: transparent;
            margin: auto;">
         <div id="ui-crosshair-center" style="
         width: 3px;
         height: 3px;
         position: absolute;
         border-radius: 100px;
         top:0;
         bottom: 0;
         left: 0;
         right: 0;
         backdrop-filter: invert(1);
         background-color: rgb(60, 255, 0);
         background-color: transparent;
         margin: auto;"></div>    
        </div>
        </div>
        <script src="/js/pwa.js"></script>
        <script src="/js/status.js"></script>
		<script type="module">
        import * as THREE from "/js/three/build/three.module.js"
        import {DeviceOrientationControls} from "/js/three/examples/jsm/controls/DeviceOrientationControls.js"
        import {PointerLockControls} from "/js/three/examples/jsm/controls/PointerLockControls.js"
        import Joystick from "/js/modules/controllers/Joystick.js"
        import Keyboard from "/js/modules/controllers/Keyboard.js"
        import Mouse from "/js/modules/controllers/Mouse.js"
        import WorldMap from "/js/modules/generators/WorldMap.js"
        import '/js/cannon/build/cannon.min.js'
        import WorldComponent from "/js/modules/operators/WorldComponent.js"
        import Player from "/js/modules/operators/Player.js"
        import Assets from "/js/modules/operators/Assets.js"
        import GameEngine from "/js/modules/engines/GameEngine.js"
        import RenderingEngine from "/js/modules/engines/RenderingEngine.js"
        import {DeviceChecker} from "/js/modules/utils/DeviceUtils.js"
            //Setup THREE JS Components
                let camera, scene, renderer, controls;
                //THREE JS Camera
                camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.01, 50 );
                //if (DeviceChecker.isMobile()) {
                //    controls = new DeviceOrientationControls( camera );
                //    controls.connect()
                //} else {
                    controls = new PointerLockControls( camera,document.body )
                    controls.minPolarAngle = 0.05;
                    controls.maxPolarAngle = Math.PI - 0.05;
                    document.addEventListener("click", ()=>{controls.lock()})
                //}
                scene = new THREE.Scene()
                //Setup world engine and variables
                const world = new CANNON.World()
                world.solver.iterations = 10;
                world.solver.tolerance = 0;
                world.gravity.set(0,-15,0);
                world.allowSleep = true;
                //Raycaster for player crosshair
                //Setup core objects 
                var Engine = new GameEngine()
                var RenderEngine = new RenderingEngine(30);
                var WRCOMP = new WorldComponent()
                var player = new Player()
                var keyboard = new Keyboard()
                var joystick = new Joystick()
                var mouse = new Mouse()
                //Load schema
                WRCOMP.textures.push(new Assets.TextureSchema("grass",{top:"/images/grass-top.jpg",side:"/images/grass-side.png",bottom:"/images/grass-bottom.jpg"}))
                //Make a function to pre-load data and attributes to the scene
                function load() {
                    //Setup the renderer/canvas
                    renderer = new THREE.WebGLRenderer( { antialias: true } );
                    renderer.setPixelRatio( window.devicePixelRatio );
                    renderer.setSize( window.innerWidth, window.innerHeight );
                    //Append the renderer into the container
                    document.getElementById('container').appendChild( renderer.domElement );
                    keyboard.connect()
                    mouse.connect()
                    WRCOMP.createSkybox(scene,renderer,'/images/background.png')
                    WRCOMP.loadObjectMap(new WorldMap(16))
                    WRCOMP.loadHeightMap(scene);
                    WRCOMP.createLightSource(scene)
                    world.addContactMaterial(WRCOMP.physicsContactMaterial); 
                    player.body.material = WRCOMP.physicsMaterial;
                    player.spawn(scene,world)
                }
                load()
                RenderEngine.render = function () {
                    if (DeviceChecker.isMobile()) {
                            //Bind player data with controller data
                            player.movingAngle = joystick.getAngle()
                            player.isMoving = joystick.getState()
                            controls.update()
                        } else {
                            player.updatePCControllers(keyboard,mouse)
                        }  
                        keyboard.logParam = scene.children;
                        player.getCrosshairTarget(camera,scene) 
                            //Optimize hitbox to appear only where it's needed
                            WRCOMP.getHitboxes(player,world)
                            //Check if a player is on the ground or not
                            player.getGroundingStatus(scene)
                            //Iterate physic time
                            world.step(1/RenderEngine.fps)
                            //Update camera angle
                            Engine.getCameraAngle(camera)
                            //Do player movement
                            player.doMovement(player.speed,Engine.camera.dirAngle,-player.movingAngle)
                            player.doAction(scene,world,WRCOMP);
                            //Update player viewport to match player movement
                            Engine.updatePlayerHitbox(player)
                            Engine.updatePlayerViewport(camera,player)
                            renderer.render( scene, camera );
                }
                RenderEngine.startAnimating()
		</script>
	</body>
</html>